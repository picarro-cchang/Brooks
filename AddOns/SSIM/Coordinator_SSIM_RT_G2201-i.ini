#Toggle Test Simulates a Direct Tank Connection with CAL.
#Toggle Test will continue until necessary parameters are reached or after the 15 minute time out.

[UserEditableParams]
num_disp_params = 0
0 = "maxTestDuration", "Maximum test duration (minutes)", "10.0"

[Mode]
inject_mode=automatic

[Files]
output = "C:\IsotopicData\SSIM"

[Output]
resultTime          = "Date/Time"                  , %15s
meanDelta           = "HR_Delta_iCH4_Raw Mean"     , %17.3f
stdDelta            = "HR_Delta_iCH4_Raw Std"      , %16.3f
mean12CH4           = "HR_12CH4 Mean"              , %17.3f
std12CH4            = "HR_12CH4 Std"               , %16.3f
meanDeltaHP         = "HP_Delta_iCH4_Raw Mean"     , %17.3f
stdDeltaHP          = "HP_Delta_iCH4_Raw Std"      , %16.3f
mean12CH4HP         = "HP_12CH4 Mean"              , %17.3f
std12CH4HP          = "HP_12CH4 Std"               , %16.3f
meanDelta_Raw_iCO2  = "Delta_Raw_iCO2"             , %17.3f
stdDelta_Raw_iCO2   = "Delta_Raw_iCO2 Std"         , %16.3f
mean12CO2           = "12CO2 Mean"                 , %17.3f
std12CO2            = "12CO2 Std"                  , %16.3f
mean13CO2           = "13CO2 Mean"                 , %17.3f
std13CO2            = "13CO2 Std"                  , %16.3f
meanH2O             = "H2O Mean"                   , %17.3f
meanadjust0         = "adjust_0 Mean"              , %0.4e
meanadjust5         = "adjust_5 Mean"              , %0.4e
meanadjust30        = "adjust_30 Mean"             , %0.4e
meanadjust87        = "adjust_87 Mean"             , %0.4e
meanadjust88        = "adjust_88 Mean"             , %0.4e
meancavPress        = "Cavity Pressure Mean"       , %17.3f
meancavTemp         = "Cavity Temperature Mean"    , %17.3f
meanWBTemp          = "Warm Box Temperature Mean"  , %17.3f

[PostProcessing]
type = deltaCorr
output = C:\IsotopicData\Corrected\

[Setup]
initial = StateInitConfig
final = StateDone
error = StateError

[StateInitConfig]
action = """

maxTestDuration = float(editParamDict["maxTestDuration"])

# Set some initial flags
t = 0
initialMeet = False

timeFormat = "%m/%d/%y %H:%M:%S"

# Define pressure setpoints
regularPressure = 148
# Lowest pressure = 10.33

setMeasBuffer("analyze_FBDS", ["HR_Delta_iCH4_Raw", "HR_12CH4", "HP_Delta_iCH4_Raw",
"HP_12CH4", "Delta_Raw_iCO2", "12CO2", "13CO2", "H2O", "adjust_0", "adjust_5",
"adjust_30", "adjust_87", "adjust_88", "CavityPressure", "CavityTemp",
"WarmBoxTemp"], 50)
clearMeasBuffer()

GUI.setStatusText("")

skipPressureCheck()

disableInstMgrAutoRestartFlow()
# Definte the pressure and inlet valve characteristics
setMaxCavityPressureRate(10)
setInletValveMaxChange(500)
setInletValveGains(80, 1)
setValveMinDac("outlet", 0)
setValveMinDac("inlet", 0)
# Get inlet and outlet max DAC
inletValveMaxDac = getValveMinMaxDac("inlet")["max"]
outletValveMaxDac = getValveMinMaxDac("outlet")["max"]

# Close all the solenoid valves at the start-up

setValveMask(0)
logFunc("\nState Clean starts...\n")
NEXT = "StateClean"
"""

[StateClean]
action = """
# Alternate flow ZA through cavity & sample loop and pumping down sample loop
# Total time: 3 mins
setValveMask(8)
sleep(10)
setValveMask(5)
sleep(20)
setValveMask(8)
sleep(10)
setValveMask(5)
sleep(30)

logFunc("\nState Toggle starts...\n")
NEXT = "StateToggle"
"""

[StateToggle]
action = """
# Toggle valves 2 and 3 while valve 5 is open to imitate a direct tank CAL connection to analyzer
sleep(2)

sumsBuffer = {"HR_Delta_iCH4_Raw":[], "HR_12CH4":[], "HP_Delta_iCH4_Raw":[], "HP_12CH4":[], "12CO2":[],
"Delta_Raw_iCO2":[],"13CO2":[], "H2O":[], "adjust_0":[], "adjust_5":[],"adjust_30":[],
"adjust_87":[], "adjust_88":[], "CavityPressure":[], "CavityTemp":[], "WarmBoxTemp":[], "Time":[]}

clearMeasBuffer()

start = time.time()
dt = time.time()-start
while dt < (60.0 * maxTestDuration):
    setValveMask(22)
    sleep(.5)
    setValveMask(20)
    sleep(.5)
    results = measGetBufferFirst()
    if results:
        sumsBuffer["HR_Delta_iCH4_Raw"].append(results["HR_Delta_iCH4_Raw"])
        sumsBuffer["HR_12CH4"].append(results["HR_12CH4"])
        sumsBuffer["HP_Delta_iCH4_Raw"].append(results["HP_Delta_iCH4_Raw"])
        sumsBuffer["HP_12CH4"].append(results["HP_12CH4"])
        sumsBuffer["Delta_Raw_iCO2"].append(results["Delta_Raw_iCO2"])
        sumsBuffer["12CO2"].append(results["12CO2"])
        sumsBuffer["13CO2"].append(results["13CO2"])
        sumsBuffer["H2O"].append(results["H2O"])
        sumsBuffer["adjust_0"].append(results["adjust_0"])
        sumsBuffer["adjust_5"].append(results["adjust_5"])
        sumsBuffer["adjust_30"].append(results["adjust_30"])
        sumsBuffer["adjust_87"].append(results["adjust_87"])
        sumsBuffer["adjust_88"].append(results["adjust_88"])
        sumsBuffer["CavityPressure"].append(results["CavityPressure"])
        sumsBuffer["CavityTemp"].append(results["CavityTemp"])
        sumsBuffer["WarmBoxTemp"].append(results["WarmBoxTemp"])

        if int(dt) % 30 == 0:
            logFunc("\n30 second update...\n")
            row = {}
            row["resultTime"] = strftime(timeFormat, localtime())
            row["meanDelta"] = mean(sumsBuffer["HR_Delta_iCH4_Raw"])
            row["stdDelta"] = std(sumsBuffer["HR_Delta_iCH4_Raw"])
            row["mean12CH4"] = mean(sumsBuffer["HR_12CH4"])
            row["std12CH4"] = std(sumsBuffer["HR_12CH4"])
            row["meanDeltaHP"] = mean(sumsBuffer["HP_Delta_iCH4_Raw"])
            row["stdDeltaHP"] = std(sumsBuffer["HP_Delta_iCH4_Raw"])
            row["mean12CH4HP"] = mean(sumsBuffer["HP_12CH4"])
            row["std12CH4HP"] = std(sumsBuffer["HP_12CH4"])
            row["meanDelta_Raw_iCO2"] = mean(sumsBuffer["Delta_Raw_iCO2"])
            row["stdDelta_Raw_iCO2"] = std(sumsBuffer["Delta_Raw_iCO2"])
            row["mean12CO2"] = mean(sumsBuffer["12CO2"])
            row["std12CO2"] = std(sumsBuffer["12CO2"])
            row["mean13CO2"] = mean(sumsBuffer["13CO2"])
            row["std13CO2"] = std(sumsBuffer["13CO2"])
            row["meanH2O"] = mean(sumsBuffer["H2O"])
            row["stdH2O"] = std(sumsBuffer["H2O"])
            row["meanadjust0"] = mean(sumsBuffer["adjust_0"])
            row["meanadjust5"] = mean(sumsBuffer["adjust_5"])
            row["meanadjust30"] = mean(sumsBuffer["adjust_30"])
            row["meanadjust87"] = mean(sumsBuffer["adjust_87"])
            row["meanadjust88"] = mean(sumsBuffer["adjust_88"])
            row["meancavPress"] = mean(sumsBuffer["CavityPressure"])
            row["meancavTemp"] = mean(sumsBuffer["CavityTemp"])
            row["meanWBTemp"] = mean(sumsBuffer["WarmBoxTemp"])
            sumsBuffer["HR_Delta_iCH4_Raw"] = []
            sumsBuffer["HR_12CH4"] = []
            sumsBuffer["HP_Delta_iCH4_Raw"] = []
            sumsBuffer["HP_12CH4"] = []
            sumsBuffer["Delta_Raw_iCO2"] = []
            sumsBuffer["12CO2"] = []
            sumsBuffer["13CO2"] = []
            sumsBuffer["H2O"] = []
            sumsBuffer["adjust_0"] = []
            sumsBuffer["adjust_5"] = []
            sumsBuffer["adjust_30"] = []
            sumsBuffer["adjust_87"] = []
            sumsBuffer["adjust_88"] = []
            sumsBuffer["CavityPressure"] = []
            sumsBuffer["CavityTemp"] = []
            sumsBuffer["WarmBoxTemp"] = []
            sumsBuffer["Time"] = []
            fileDataFunc(row)
            import math
            conditionsMet = (dt > 240 and
            math.fabs(row["meanadjust0"]) < 0.001 and math.fabs(row["meanadjust0"]) < 0.001 and
            math.fabs(row["meanadjust5"]) < 0.001 and math.fabs(row["meanadjust5"]) < 0.001 and
            math.fabs(row["meanadjust30"]) < 0.001 and math.fabs(row["meanadjust30"]) < 0.001 and
            math.fabs(row["meanadjust87"]) < 0.001 and math.fabs(row["meanadjust87"]) < 0.001 and
            math.fabs(row["meanadjust88"]) < 0.001 and math.fabs(row["meanadjust88"]) < 0.001 and
            math.fabs(row["meancavPress"]) >= 147.8 and math.fabs(row["meancavPress"] <= 148.2) and
            math.fabs(row["meancavTemp"]) >= 44.9 and math.fabs(row["meancavTemp"] <= 45.1) and
            math.fabs(row["meanWBTemp"]) >= 44.9 and math.fabs(row["meanWBTemp"] <= 45.1))
            if conditionsMet and not initialMeet:
                initialMeet = True
            elif conditionsMet and initialMeet:
                NEXT = "StateEvacuateAtTheEnd"
                break
        dt = time.time() - start

NEXT = "StateEvacuateAtTheEnd"
"""

[StateEvacuateAtTheEnd]
action = """

# Evacuate the cavity
logFunc("\nEvacuating the cavity...\n")
currOutletDac = getValveDacValues()["outletDacValue"]
sleep(5)
NEXT = "StateDone"
"""

[StateDone]
action="""
setValveMask(0)
resumePressureCheck()
enableInstMgrAutoRestartFlow()
logFunc("Done!")
"""

[StateError]
action="""
logFunc("Error %s in state %s\n" % (ERROR_MSG,ERROR_STATE))
NEXT = "StateDone"
"""
