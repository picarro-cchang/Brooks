from ctypes import byref, c_ubyte, create_string_buffer
from usb import LibUSB
from hexfile import HexFile
from time import sleep
from cStringIO import StringIO
from array import array

sampleHex1 = """
:0A0C5000000102020303040405057D
:1002A100E4F513F512F511F510C203C200C202C242
:1002B100011205537E087F008E238F24752B08754C
:1002C1002C1275210875221C752908752A4A752D6D
:1002D10008752E78EE54E070030203E5751400757D
:1002E10015808E168F17C374A49FFF74089ECF24A8
:1002F10002CF3400FEE48F0F8E0EF50DF50CF50BD9
:10030100F50AF509F508AF0FAE0EAD0DAC0CAB0B50
:10031100AA0AA909A808C31209815026E515250BC7
:10032100F582E514350AF58374CDF0E50B2401F56A
:100331000BE4350AF50AE43509F509E43508F50851
:1003410080C4E4F50BF50AF509F508AF0FAE0EAD63
:100351000DAC0CAB0BAA0AA909A808C3120981505C
:1003610031AE0AAF0BE5172FF582E5163EF583E0B6
:10037100FDE5152FF582E5143EF583EDF0EF24013F
:10038100F50BE43EF50AE43509F509E43508F5080D
:1003910080B985142385152474002480FF740834E2
:1003A100FFFEC3E52C9FF52CE52B9EF52BC3E5261F
:1003B1009FF526E5259EF525C3E5289FF528E52728
:1003C1009EF527C3E5229FF522E5219EF521C3E590
:1003D1002A9FF52AE5299EF529C3E52E9FF52EE5ED
:1003E1002D9EF52DD2E843D82090E668E04409F02F
:1003F10090E65CE0443DF0D2AF90E680E020E1057C
:10040100D204120AFD90E680E054F7F0538EF8C250
:1004110003300105120080C2013003291207FE508A
:1004210024C2031206DB20001690E682E030E704C6
:10043100E020E1EF90E682E030E604E020E0E41223
:0A0441000B2C120C7612063880C74F
:1000800090E6B9E0700302012E1470030201AB2464
:10009000FE700302022E24FB700302012814700379
:1000A0000201221460701460732405600302028D43
:1000B000120C78400302029990E6BBE024FE602215
:1000C00014603324FD601114602224067045E5237A
:1000D00090E6B3F0E5248034E52B90E6B3F0E52C10
:1000E000802AE52590E6B3F0E5268020E52790E616
:1000F000B3F0E528801690E6BAE0FF120B58AA0686
:10010000A907EA49600DEE90E6B3F0EF90E6B4F08F
:10011000020299020292120C3E020299120C620231
:100120000299120C5A020299120C2C020299120C1A
:100130007A400302029990E6B8E0247F60151460CB
:100140001924027063A200E43325E0FFA202E43325
:100150004F8041E490E740F0803F90E6BCE0547E61
:10016000FF7E00E0D394807C0040047D0180027D0E
:1001700000EC4EFEED4F2450F582740C3EF583E406
:1001800093FF3395E0FEEF24A1FFEE34E68F82F576
:1001900083E0540190E740F0E4A3F090E68AF09009
:1001A000E68B7402F0020299020292120C7C400368
:1001B00002029990E6B8E024FE6016240260030271
:1001C000029990E6BAE0B40105C200020299020267
:1001D0009290E6BAE0705590E6BCE0547EFF7E0057
:1001E000E0D394807C0040047D0180027D00EC4ED1
:1001F000FEED4F2450F582740C3EF583E493FF33FB
:1002000095E0FEEF24A1FFEE34E68F82F583E05403
:10021000FEF090E6BCE05480131313541FFFE0542B
:100220000F2F90E683F0E04420F0806D8064120C84
:100230007E506690E6B8E024FE60192402705A9061
:10024000E6BAE0B40104D200804F90E6BAE064025E
:100250006047803E90E6BCE0547EFF7E00E0D39491
:10026000807C0040047D0180027D00EC4EFEED4F5D
:100270002450F582740C3EF583E493FF3395E0FE41
:10028000EF24A1FFEE34E68F82F5838008120992F5
:10029000500790E6A0E04401F090E6A0E04480F032
:0102A000223B
:03003300020C724A
:040C720053D8EF3232
:100800001201000200000040B404021000000102C6
:1008100000010A06000200000040010009022E004B
:1008200001010080320904000004FF0000000705F8
:10083000020200020007050402000200070586020A
:100840000002000705880200020009022E000101D3
:100850000080320904000004FF00000007050202C6
:100860004000000705040240000007058602400022
:10087000000705880240000004030904100350002B
:10088000690063006100720072006F00180350007D
:10089000690063006100720072006F002D00550056
:0608A000530042000000BD
:100C1800501000C0F9A4B0999282F880988883C6D1
:030C2800A1868E14
:1005530090E600E054E74410F090E601E04440F0F8
:1005630090E61074A0F090E611F000000090E612FF
:1005730074A2F000000090E61374A0F00000009055
:10058300E61474E2F000000090E61574E0F0000059
:100593000090E6917480F0000000F000000090E607
:1005A30095F0000000F0E4FFFEE4F518F51974007F
:1005B3002519F58274F83518F583E519F00519E561
:1005C30019700205186440451870E3000000E490B8
:1005D300E698F000000090E6997440F00FBF000128
:1005E3000EEF64024E70C2E4FEFFE4F518F519C382
:1005F30074409519FD74002519F58274FC3518F5BE
:1006030083EDF00519E5197002051864404518706B
:10061300DE000000E490E69CF000000090E69D748C
:1006230040F00FBF00010EEF64024E70BD43AF01F7
:05063300D200020C6A78
:10063800E4F518F519E5AA20E511000000E490E6B4
:1006480098F000000090E6997440F0E5AA20E711C0
:10065800000000E490E69CF000000090E69D7440E5
:10066800F0E5AA20E03D790074F0F59A7400F59B56
:1006780090E690E0FE90E691E07C002400FFEC3EDE
:10068800FEE4FDC3ED9FEC9E500D90E67BE0F5186F
:100698000DBD00010C80EC75190100000090E69179
:1006A8007480F0E5AA20E20900000090E6957480C5
:1006B800F0E519601DE518540F2400F582E43410A4
:1006C800AB82FA7D017F21120BA07F21120A61E41F
:0206D800F51912
:0106DA0022FD
:0207FE00D32204
:020C7600D32287
:020C7800D32285
:080C5A0090E6BAE0F530D32268
:100C2C0090E740E530F0E490E68AF090E68B04F033
:020C3C00D322C1
:080C620090E6BAE0F52FD32261
:100C3E0090E740E52FF0E490E68AF090E68B04F022
:020C4E00D322AF
:020C7A00D32283
:020C7C00D32281
:020C7E00D3227F
:1009920090E6B9E0242F601414602014602A240326
:1009A200704690E604E0FD430580800890E604E08E
:1009B200FD53057F000000EDF0802F90E740743476
:1009C200F0A37412F0E4800D90E680E0548090E78A
:1009D20040F0E4A3F090E68AF090E68B7402F09087
:0B09E200E6A0E04480F08002D322C3B6
:0109ED0022E7
:100BBC00C0E0C083C082D2015391EF90E65D740116
:080BCC00F0D082D083D0E032AA
:100BEC00C0E0C083C0825391EF90E65D7404F0D0F6
:060BFC0082D083D0E0323C
:100C0200C0E0C083C0825391EF90E65D7402F0D0E1
:060C120082D083D0E03225
:100A2B00C0E0C083C082852925852A26852682853C
:100A3B002583A37402F085212785222885288285AA
:100A4B002783A37407F05391EF90E65D7410F0D0F9
:060A5B0082D083D0E032DE
:100BD400C0E0C083C082D2035391EF90E65D7408F5
:080BE400F0D082D083D0E03292
:1009EE00C0E0C083C08290E680E030E720852125FC
:1009FE00852226852682852583A37402F0852927E4
:100A0E00852A28852882852783A37407F05391EFC2
:0D0A1E0090E65D7420F0D082D083D0E032ED
:010C80003241
:010C81003240
:010C8200323F
:010C8300323E
:010C8400323D
:010C8500323C
:010C8600323B
:010C8700323A
:010C88003239
:010C89003238
:010C8A003237
:010C8B003236
:010C8C003235
:010C8D003234
:010C8E003233
:010C8F003232
:010C90003231
:010C91003230
:010C9200322F
:010C9300322E
:010C9400322D
:010C9500322C
:010C9600322B
:010C9700322A
:010C98003229
:010C99003228
:010C9A003227
:010C9B003226
:010C9C003225
:010C9D003224
:010C9E003223
:010C9F003222
:010CA0003221
:010CA1003220
:010CA200321F
:010CA300321E
:100B2C0090E682E030E004E020E60B90E682E030D4
:100B3C00E119E030E71590E680E04401F07F147E87
:0C0B4C00001207B890E680E054FEF02292
:1006DB0090E682E044C0F090E681F0438701000091
:0406EB0000000022E9
:100AFD0030040990E680E0440AF0800790E680E03B
:100B0D004408F07FDC7E051207B890E65D74FFF0B7
:0F0B1D0090E65FF05391EF90E680E054F7F022FE
:080C6A00E4F51FD2E9D2AF222C
:100A610090E678E020E6F9C2E990E678E04480F08B
:100A7100EF25E090E679F090E678E030E0F990E655
:100A810078E04440F090E678E020E6F990E678E0FE
:060A910030E1D6D2E9229B
:100ACB00A90790E678E020E6F9E51F702390E67819
:100ADB00E04480F0E925E090E679F08D1AAF03A9A8
:100AEB0007751B018A1C891DE4F51E751F01D32296
:020AFB00C32214
:100A9700A90790E678E020E6F9E51F702590E6784B
:100AA700E04480F0E925E0440190E679F08D1AAF43
:100AB70003A907751B018A1C891DE4F51E751F0311
:040AC700D322C32251
:03004B0002044B61
:10044B00C0E0C083C082C085C084C086758600C0F2
:10045B00D075D000C000C001C002C003C006C007E9
:10046B0090E678E030E206751F0602053590E678D7
:10047B00E020E10CE51F64026006751F07020535DD
:10048B00E51F24FE605F14603624FE700302052610
:10049B0024FC700302053224086003020535AB1BF4
:1004AB00AA1CA91DAF1E051E8F827583001209326F
:1004BB0090E679F0E51E651A7070751F05806B90DC
:1004CB00E679E0AB1BAA1CA91DAE1E8E82758300BC
:1004DB0012095F751F02E51A6401704E90E678E011
:1004EB004420F08045E51A24FEB51E0790E678E01F
:1004FB004420F0E51A14B51E0A90E678E04440F06B
:10050B00751F0090E679E0AB1BAA1CA91DAE1E8ED1
:10051B008275830012095F051E800F90E678E04418
:10052B0040F0751F008003751F005391DFD007D07B
:10053B0006D003D002D001D000D0D0D086D084D04A
:08054B0085D082D083D0E0329C
:020B5800A907EB
:100B5A00AE2DAF2E8F828E83A3E064037017AD0192
:100B6A0019ED7001228F828E83E07C002FFDEC3E0E
:090B7A00FEAF0580DF7E007F0064
:010B8300224F
:100B8400120A97E51F24FA600E146006240770F316
:0C0B9400D322E4F51FD322E4F51FD32286
:100BA000120ACBE51F24FA600E146006240770F3C6
:0C0BB000D322E4F51FD322E4F51FD3226A
:1007B8008E188F1990E600E054187012E51924017C
:1007C800FFE43518C313F518EF13F519801590E6F3
:1007D80000E05418FFBF100BE51925E0F519E518DE
:1007E80033F518E5191519AE18700215184E60057D
:0607F8001206EF80EE2264
:1006EF007400F58690FDA57C05A3E582458370F91E
:0106FF0022D8
:03004300020700B1
:03005300020700A1
:10070000020BBC00020C0200020BEC00020BD40036
:10071000020A2B000209EE00020C8000020C81008C
:10072000020C8200020C8300020C8400020C850083
:10073000020C8600020C8700020C8800020C890063
:10074000020C8A00020C8100020C8B00020C8C004F
:10075000020C8D00020C8E00020C8F00020C900027
:10076000020C9100020C8100020C8100020C81003D
:10077000020C9200020C9300020C9400020C9500F3
:10078000020C9600020C9700020C9800020C9900D3
:10079000020C9A00020C9B00020C9C00020C9D00B3
:1007A000020C9E00020C9F00020CA000020CA10093
:0807B000020CA200020CA300E0
:030000000208A64D
:0C08A600787FE4F6D8FD7581300208ED83
:10093200BB010CE58229F582E5833AF583E022507A
:1009420006E92582F8E622BBFE06E92582F8E222C4
:0D095200E58229F582E5833AF583E49322DE
:10095F00F8BB010DE58229F582E5833AF583E8F0CE
:10096F00225006E92582C8F622BBFE05E92582C87A
:02097F00F22262
:10098100EB9FF5F0EA9E42F0E99D42F0E89C45F0CC
:010991002243
:1008B2000202A1E493A3F8E493A34003F68001F2B9
:1008C20008DFF48029E493A3F85407240CC8C33347
:1008D200C4540F4420C8834004F456800146F6DF16
:1008E200E4800B0102040810204080900C18E47E82
:1008F200019360BCA3FF543F30E509541FFEE4930B
:10090200A360010ECF54C025E060A840B8E493A3D1
:10091200FAE493A3F8E493A3C8C582C8CAC583CAFC
:10092200F0A3C8C582C8CAC583CADFE9DEE780BEB4
:010C2B0000C8
:00000001FF
"""

if __name__ == "__main__":
    myVid = 0x4B4
    myPid = 0x8613
#    myPid = 0x81
#    myVid = 0x547
#    myPid = 0x1002
    
    epOut = 0x02
        
    usb = LibUSB()
    usb.usbInit()
    print "usbFindBusses returns %d"  % usb.usbFindBusses()
    print "usbFindDevices returns %d" % usb.usbFindDevices()
    handle = None
    for bus in usb.usbBusses():
        print bus.dirname
        for pDev in usb.usbDevices(bus):
            dev = pDev.contents
            print "%s,%x,%x" % (dev.filename, dev.descriptor.idVendor, dev.descriptor.idProduct)
            if dev.descriptor.idVendor == myVid and dev.descriptor.idProduct == myPid:
                handle = usb.usbOpen(pDev)
    if handle == None:
        raise ValueError("Device with VID: 0x%x, PID: 0x%x not found" % (myVid,myPid))
    if usb.usbSetConfiguration(handle,1) < 0:
        usb.usbClose(handle)
        raise ValueError("Setting config 1 failed")
    if usb.usbClaimInterface(handle,0) < 0:
        usb.usbClose(handle)
        raise ValueError("Claiming interface 0 failed")

    # Hold the 8051 in reset by sending it a vendor command
    usb.usbControlMsg(handle,0x40,0xA0,0xE600,0x00,byref(c_ubyte(0x1)),1,5000)

    # Use the same vendor command to load in the hexadecimal data
    fp = StringIO(sampleHex1)
    hexFile = HexFile(fp)
    regions = hexFile.process()

    block = 128 # Maximum length for download    
    for r in regions:
        # r.data contains the data as a list of bytes.
        n = len(r.data)
        addr = r.address
        start = 0
        # Split into chunks of size at most "block" for sending to the FX2
        while n > block:
            usb.usbControlMsg(handle,0x40,0xA0,addr+start,0x00,
            create_string_buffer("".join(r.data[start:start+block]),block),block,5000)
            n -= block
            start += block
        if n>0:
            usb.usbControlMsg(handle,0x40,0xA0,addr+start,0x00,
            create_string_buffer("".join(r.data[start:start+n]),n),n,5000)

    # Release the 8051 reset, allowing it to renumerate
    usb.usbControlMsg(handle,0x40,0xA0,0xE600,0x00,byref(c_ubyte(0x0)),1,5000)

    usb.usbReleaseInterface(handle,0)
    usb.usbClose(handle)
