from ctypes import byref, c_ubyte, create_string_buffer
from usb import LibUSB
from hexfile import HexFile
from time import sleep
from cStringIO import StringIO
from array import array

sampleHex1 = """
:100D00001201000200000040EF0301100000010288
:100D100000010A06000200000040010009022E0046
:100D200001010040320904000004FF000000070533
:100D30000202000200070504020002000705860205
:100D40000002000705880200020009022E000101CE
:100D50000040320904000004FF0000000705020201
:100D6000400000070504024000000705860240001D
:100D70000007058802400000040309041003500026
:100D8000690063006100720072006F001803500078
:100D9000690063006100720072006F002D00550051
:060DA000530042000000B8
:0A10A2000001020203030404050527
:1007E700E4F513F512F511F510C203C200C202C2F7
:1007F70001120B267E0D7F008E238F24752B0D751E
:100807002C1275210D75221C75290D752A4A752D17
:100817000D752E78EE54E0700302092B75140075E0
:1008270015808E168F17C374A49FFF740D9ECF2457
:1008370002CF3400FEE48F0F8E0EF50DF50CF50B8D
:10084700F50AF509F508AF0FAE0EAD0DAC0CAB0B05
:10085700AA0AA909A808C3120EAD5026E515250B4B
:10086700F582E514350AF58374CDF0E50B2401F51F
:100877000BE4350AF50AE43509F509E43508F50806
:1008870080C4E4F50BF50AF509F508AF0FAE0EAD18
:100897000DAC0CAB0BAA0AA909A808C3120EAD50E0
:1008A70031AE0AAF0BE5172FF582E5163EF583E06B
:1008B700FDE5152FF582E5143EF583EDF0EF2401F4
:1008C700F50BE43EF50AE43509F509E43508F508C2
:1008D70080B985142385152474002480FF740D3492
:1008E700FFFEC3E52C9FF52CE52B9EF52BC3E526D4
:1008F7009FF526E5259EF525C3E5289FF528E527DD
:100907009EF527C3E5229FF522E5219EF521C3E544
:100917002A9FF52AE5299EF529C3E52E9FF52EE5A1
:100927002D9EF52DD2E843D82090E668E04409F0E3
:1009370090E65CE0443DF0D2AF90E680E020E10530
:10094700D205120EF490E680E054F7F0538EF8C209
:10095700033001051203F6C2013003291210B85003
:1009670024C203120FA320001690E682E030E704AA
:10097700E020E1EF90E682E030E604E020E0E412D8
:0A0987000F231210BA12061780C7E2
:1003F60090E6B9E070030204A414700302052124F8
:10040600FE70030205A424FB700302049E1470030D
:1004160002049814607014607324056003020603D6
:100426001210BC400302060F90E6BBE024FE6022D9
:1004360014603324FD601114602224067045E52300
:1004460090E6B3F0E5248034E52B90E6B3F0E52C96
:10045600802AE52590E6B3F0E5268020E52790E69C
:10046600B3F0E528801690E6BAE0FF120F4FAA0611
:10047600A907EA49600DEE90E6B3F0EF90E6B4F016
:1004860002060F02060812109002060F1210AC02A6
:10049600060F120CB802060F12107E02060F12107B
:1004A600BE400302060F90E6B8E0247F6015146094
:1004B6001924027063A200E43325E0FFA202E433AC
:1004C6004F8041E490E740F0803F90E6BCE0547EE8
:1004D600FF7E00E0D394807C0040047D0180027D95
:1004E60000EC4EFEED4F24A2F58274103EF583E437
:1004F60093FF3395E0FEEF24A1FFEE34E68F82F5FD
:1005060083E0540190E740F0E4A3F090E68AF0908F
:10051600E68B7402F002060F0206081210C04003B2
:1005260002060F90E6B8E024FE601624026003027D
:10053600060F90E6BAE0B40105C20002060F0206F5
:100546000890E6BAE0705590E6BCE0547EFF7E0067
:10055600E0D394807C0040047D0180027D00EC4E57
:10056600FEED4F24A2F58274103EF583E493FF332B
:1005760095E0FEEF24A1FFEE34E68F82F583E0548A
:10058600FEF090E6BCE05480131313541FFFE054B2
:100596000F2F90E683F0E04420F0806D8064121007
:1005A600C2506690E6B8E024FE60192402705A90A4
:1005B600E6BAE0B40104D200804F90E6BAE06402E5
:1005C6006047803E90E6BCE0547EFF7E00E0D39418
:1005D600807C0040047D0180027D00EC4EFEED4FE4
:1005E60024A2F58274103EF583E493FF3395E0FE72
:1005F600EF24A1FFEE34E68F82F583800812008097
:10060600500790E6A0E04401F090E6A0E04480F0B8
:0106160022C1
:030033000210B404
:0410B40053D8EF32EC
:10099100608018002101013F01013F0701000003B0
:1009A1000000030007030103070507070900000012
:1009B1000000003F2101013F01013F070100020149
:1009C10000020100070200020604060709000000F8
:1009D1000000003F02021302022EB80700000102CC
:1009E10000010300030101070505070700000000DE
:1009F10000002D3F02021302022E380700020304F9
:100A010002030500020000060404070700000000BD
:100A110000002D3F60241887000000000000000046
:100A210000000000000000000000000000000000C5
:100A3100000000000000000000000000471880E0F6
:060A4100000007EA4E0070
:100A6B0090E60174EAF090E6F574FFF0901880E0E0
:100A7B0090E6F3F0901881E090E6C3F0901882E0D6
:100A8B0090E6C1F0901883E090E6C2F0901885E0F4
:100A9B0090E6C0F0901886E090E6F4F075AF07741E
:100AAB0018F59A7400F59B759DE4E4F59EFF90E6AE
:100ABB007BE090E67CF00FBF80F4E490E671F0F5FC
:100ACB00B490E672E0547FF053B67F000000E490E0
:100ADB00E6C4F000000090E6C5F0901887E090E6C1
:100AEB00C6F0901888E090E6C7F0901889E090E681
:100AFB00C8F090188AE090E6C9F090188BE090E669
:100B0B00CAF090188CE090E6CBF090188DE090E650
:0A0B1B00CCF090188EE090E6CDF0CB
:010B250022AD
:100A47004218B000004118AF004218AB0000C104C3
:100A57000234000002310000012F004118AD0041AF
:030A670018AE00C6
:0C0FC80090E741E090E740FEE0FDEDFF07
:100FD400AD07AC06E5BB30E7FB90E6F0ECF0ED9036
:040FE400E6F1F02220
:060F7B00AB1AAA1BA91C21
:100F8100E5BB30E7FB90E6F1E0F52FE5BB30E7FB91
:100F910090E6F2E0FE90E6F0E0FDEDFFEE8FF0026C
:020FA1000E8EB2
:100B260000000090E600E054E74410F0000000905A
:100B3600E605E054FDF0D20090E61074A0F090E6D1
:100B460011F000000090E612F0000000E490E613B9
:100B5600F000000090E61474E0F0000000E490E677
:100B660015F000000090E6047480F00000007402A6
:100B7600F00000007406F0000000E4F000000090B1
:100B8600E61804F00000007411F000000090E61A68
:100B96007409F0000000E490E68DF0120A6B90E60E
:100BA600727408F075B693E4F5B1F59890E67004A2
:0D0BB600F043B2BE758081E490E6FBF022B2
:10061700E5BB20E7030206C3E5AB30E1030206C3EF
:1006270090E6F4E070047F0180027F00EF20E0F0A5
:1006370090E6ABE0FE90E6ACE0FDAC06ECC313FC45
:10064700ED1324FEFD74FF3CFCD3ED9400EC940005
:100657004025758089AF0490E6D0EFF0000000AF29
:1006670005EF90E6D1F0000000E4F5BB000000E5DF
:10067700BB30E7FB00000090E6F4E070047F0180E8
:10068700027F00EF20E0F075808DE490E6D0F00067
:10069700000090E6D17402F0000000E4F5BB000012
:1006A70000E5BB30E7FB00000090E6F4E070047F54
:1006B7000180027F00EF20E0F00000009018ABE01F
:1006C7007002A3E070030207B1E5BB20E70302074E
:1006D700B1E5AC30E0030207B190E6F4E070047FC7
:1006E7000180027F00EF20E0F09018ACE024FEF0DC
:1006F7009018ABE034FFF0D3A3E094009018ABE080
:10070700648094804038758089E490E6CEF00000DC
:100717000090E6CFF00000009018ABE0FCA3E0FDEE
:10072700EC90E6D0F0000000ED90E6D1F00000007C
:1007370075BB06000000E5BB30E7FB0000007580D5
:100747008DE490E6CEF000000090E6CFF0000000C8
:1007570090E6D0F000000090E6D17402F0000000AF
:1007670075BB06000000E5BB30E7FB00000090E624
:10077700AFE0FE90E6B0E0FDEEF531EDF532C39562
:1007870035E5319534500690E6487406F0E4901844
:10079700ABF0A3F075808D90E6F4E070047F0180E4
:1007A700027F00EF20E0F00000009018B0E475F041
:1007B70001120E78AFF0FEBE2725BF10229018AFAA
:1007C700E07F01600A120FE8E49018AFF080091289
:0F07D70010059018AF7401F0E49018B0F0A3F083
:0107E60022F0
:0210B800D32241
:0210BA00D3223F
:0210BC00D3223D
:100CB80090E680E030E71D00000090E6247402F022
:100CC800000000E490E625F0000000D2047534042A
:100CD800F535801B000000E490E624F00000009049
:100CE800E6257440F0000000C204753400F5359024
:070CF800E6BAE0F533D32258
:10107E0090E740E533F0E490E68AF090E68B04F0DA
:02108E00D3226B
:0810AC0090E6BAE0F530D32212
:1010900090E740E530F0E490E68AF090E68B04F0CB
:0210A000D32259
:0210BE00D3223B
:0210C000D32239
:0210C200D32237
:1000800090E6BBE0FE90E6BAE0FDEEF518EDF5195E
:1000900090E6BFE0FE90E6BEE0FDEDFFE4F51DF565
:1000A0001E90E6B9E02450603624F0B40A00400304
:1000B0000203F29000C175F003A4C58325F0C58347
:1000C000730200F60201FC02024902028B0202D80E
:1000D00002031B02034802019602036E0203999079
:1000E000E74074E9F0A37403F0E490E68AF090E648
:1000F0008B74020203E8E5186003020194E51924F9
:10010000FE603B1460662402600302019475B6939E
:1001100075B110000000000000000053B1EF0000B6
:1001200000000000000043B11075B68390E74074F2
:1001300001F0E490E68AF090E68B040203E8E49094
:10014000E68BF0E5BA20E0FBE4FDFCC3ED9FEC9EFE
:1001500040030203F474402DF582E434E7F583E0B4
:10016000F5995398FD0DBD00010C80DFAFB1EF3064
:10017000E6047E0280027E00EF30E5047F0180020B
:100180007F00EF4E90E740F0E490E68AF090E68B37
:10019000040203E8D322E5187060E51924FE601B11
:1001A00014602A24027053A204E43390E740F0E480
:1001B00090E68AF090E68B040203E890E740E5BB06
:1001C000F0E490E68AF090E68B040203E890E6D132
:1001D000E090E740F090E6D0E090E741F090E6CF85
:1001E000E090E742F090E6CEE090E743F0E490E65E
:1001F0008AF090E68B74040203E8D32290E6F4E0E0
:1002000070047F0180027F00EF20E0F0751A017515
:100210001BE7751C40758081000000120F7BE5BB59
:1002200030E7FB7402251CF51CE4351BF51B7580BB
:1002300083000000120F7BE5BB30E7FBE490E68A09
:10024000F090E68B74040203E8E490E68BF0E5BAE4
:1002500020E0FB90E6F4E070047F0180027F00EF75
:1002600020E0F0758081000000120FC8E5BB30E788
:10027000FB75808300000090E743E090E742120F97
:10028000CFE5BB30E7030203F480F690E6F4E070BC
:10029000047F0180027F00EF20E0F0751A01751BDA
:1002A000E7751C40758085000000120F7BE5BB30B0
:1002B000E7FB7402251CF51CE4351BF51B758087D4
:1002C000000000120F7BE5BB30E7FBE490E68AF00C
:1002D00090E68B74040203E8E490E68BF0E5BA2024
:1002E000E0FB90E6F4E070047F0180027F00EF20E5
:1002F000E0F0758085000000120FC8E5BB30E7FB19
:1003000075808700000090E743E0FE90E742120FFF
:10031000D0E5BB30E7030203F480F6E490E68BF00F
:10032000E5BA20E0FB90E741E0FE90E740E0FDED1C
:10033000FF9018ABEEF0A3EFF09018ABE0A2E7133C
:10034000F0A3E013F00203F490E6047480F00000E0
:10035000007406F0000000E4F000000090E74004A4
:10036000F0E490E68AF090E68B04F00203F4E519DD
:1003700030E00553807F8003438080E51930E1053C
:100380005380FE800343800190E740E519F0E4903C
:10039000E68AF090E68B04804F90E680E04408F017
:1003A000E4FFFEE4FDFCEF2DFBEE3CFAEB251EF531
:1003B0001EEA351DF51D0DBD00010CED64644C7089
:1003C000E50FBF00010EBE07DABFD0D7E490E6FB11
:1003D000F000000090E680E054F7F0E490E740F091
:1003E00090E68AF090E68B04F090E6A0E04480F07E
:0503F0008002D322C3CE
:0103F50022E5
:10102200C0E0C083C082D2015391EF90E65D7401AB
:08103200F0D082D083D0E0323F
:10105200C0E0C083C0825391EF90E65D7404F0D08B
:0610620082D083D0E032D1
:10106800C0E0C083C0825391EF90E65D7402F0D077
:0610780082D083D0E032BB
:100EBE00C0E0C083C082852925852A2685268285A5
:100ECE002583A37402F08521278522288528828513
:100EDE002783A37407F05391EF90E65D7410F0D062
:060EEE0082D083D0E03247
:10103A00C0E0C083C082D2035391EF90E65D74088A
:08104A00F0D082D083D0E03227
:100BC300C0E0C083C08290E680E030E72085212525
:100BD300852226852682852583A37402F08529270D
:100BE300852A28852882852783A37407F05391EFEC
:0D0BF30090E65D7420F0D082D083D0E03217
:010CFF0032C2
:0110C40032F9
:0110C50032F8
:0110C60032F7
:0110C70032F6
:0110C80032F5
:0110C90032F4
:0110CA0032F3
:0110CB0032F2
:0110CC0032F1
:0110CD0032F0
:0110CE0032EF
:0110CF0032EE
:0110D00032ED
:0110D10032EC
:0110D20032EB
:0110D30032EA
:0110D40032E9
:0110D50032E8
:0110D60032E7
:0110D70032E6
:0110D80032E5
:0110D90032E4
:0110DA0032E3
:0110DB0032E2
:0110DC0032E1
:0110DD0032E0
:0110DE0032DF
:0110DF0032DE
:0110E00032DD
:0110E10032DC
:0110E20032DB
:0110E30032DA
:0110E40032D9
:0110E50032D8
:0110E60032D7
:100FE800EF30E00353B1FEEF30E10353B1FDEF30D2
:0D0FF800E20353B17FEF30E3035380EF229B
:10100500EF30E00343B101EF30E10343B102EF30CC
:0D101500E20343B180EF30E303438010227B
:100F230090E682E030E004E020E60B90E682E030D9
:100F3300E119E030E71590E680E04401F07F147E8C
:0C0F430000120E3290E680E054FEF02216
:100FA30090E682E044C0F090E681F04387010000C0
:040FB3000000002218
:100EF40030050990E680E0440AF0800790E680E03F
:100F04004408F07FDC7E05120E3290E65D74FFF03B
:0F0F140090E65FF05391EF90E680E054F7F02203
:020F4F00A907F0
:100F5100AE2DAF2E8F828E83A3E064037017AD0197
:100F610019ED7001228F828E83E07C002FFDEC3E13
:090F7100FEAF0580DF7E007F0069
:010F7A002254
:100E32008E188F1990E600E054187012E5192401FB
:100E4200FFE43518C313F518EF13F519801590E672
:100E520000E05418FFBF100BE51925E0F519E5185D
:100E620033F518E5191519AE18700215184E6005FC
:060E7200120FB780EE2212
:100FB7007400F58690FDA57C05A3E582458370F94D
:010FC7002207
:03004300020C00AC
:03005300020C009C
:100C000002102200021068000210520002103A0086
:100C1000020EBE00020BC300020CFF000210C40053
:100C20000210C5000210C6000210C7000210C80062
:100C30000210C9000210CA000210CB000210CC0042
:100C40000210CD000210C4000210CE000210CF002E
:100C50000210D0000210D1000210D2000210D30006
:100C60000210D4000210C4000210C4000210C4001C
:100C70000210D5000210D6000210D7000210D800D2
:100C80000210D9000210DA000210DB000210DC00B2
:100C90000210DD000210DE000210DF000210E00092
:100CA0000210E1000210E2000210E3000210E40072
:080CB0000210E5000210E6004D
:03000000020DA648
:0C0DA600787FE4F6D8FD758135020DED74
:100E7800C5F0F8A3E028F0C5F0F8E5821582700205
:060E88001583E038F022A2
:100E8E00BB010A89828A83F0E5F0A3F0225006F7AF
:0F0E9E0009A7F01922BBFE06F3E5F009F31922AC
:100EAD00EB9FF5F0EA9E42F0E99D42F0E89C45F09B
:010EBD002212
:100DB2000207E7E493A3F8E493A34003F68001F269
:100DC20008DFF48029E493A3F85407240CC8C33342
:100DD200C4540F4420C8834004F456800146F6DF11
:100DE200E4800B0102040810204080900991E47E07
:100DF200019360BCA3FF543F30E509541FFEE49306
:100E0200A360010ECF54C025E060A840B8E493A3CC
:100E1200FAE493A3F8E493A3C8C582C8CAC583CAF7
:100E2200F0A3C8C582C8CAC583CADFE9DEE780BEAF
:010A6A00008B
:00000001FF
"""

if __name__ == "__main__":
    myVid = 0x4B4
    myPid = 0x8613
#    myPid = 0x81
#    myVid = 0x3ef
#    myPid = 0x1000
    
    epOut = 0x02
        
    usb = LibUSB()
    usb.usbInit()
    print "usbFindBusses returns %d"  % usb.usbFindBusses()
    print "usbFindDevices returns %d" % usb.usbFindDevices()
    handle = None
    for bus in usb.usbBusses():
        print bus.dirname
        for pDev in usb.usbDevices(bus):
            dev = pDev.contents
            print "%s,%x,%x" % (dev.filename, dev.descriptor.idVendor, dev.descriptor.idProduct)
            if dev.descriptor.idVendor == myVid and dev.descriptor.idProduct == myPid:
                handle = usb.usbOpen(pDev)
    if handle == None:
        raise ValueError("Device with VID: 0x%x, PID: 0x%x not found" % (myVid,myPid))
    if usb.usbSetConfiguration(handle,1) < 0:
        usb.usbClose(handle)
        raise ValueError("Setting config 1 failed")
    if usb.usbClaimInterface(handle,0) < 0:
        usb.usbClose(handle)
        raise ValueError("Claiming interface 0 failed")

    # Hold the 8051 in reset by sending it a vendor command
    usb.usbControlMsg(handle,0x40,0xA0,0xE600,0x00,byref(c_ubyte(0x1)),1,5000)

    # Use the same vendor command to load in the hexadecimal data
    fp = StringIO(sampleHex1)
    hexFile = HexFile(fp)
    regions = hexFile.process()

    block = 128 # Maximum length for download    
    for r in regions:
        # r.data contains the data as a list of bytes.
        n = len(r.data)
        addr = r.address
        start = 0
        # Split into chunks of size at most "block" for sending to the FX2
        while n > block:
            usb.usbControlMsg(handle,0x40,0xA0,addr+start,0x00,
            create_string_buffer("".join(r.data[start:start+block]),block),block,5000)
            n -= block
            start += block
        if n>0:
            usb.usbControlMsg(handle,0x40,0xA0,addr+start,0x00,
            create_string_buffer("".join(r.data[start:start+n]),n),n,5000)

    # Release the 8051 reset, allowing it to renumerate
    usb.usbControlMsg(handle,0x40,0xA0,0xE600,0x00,byref(c_ubyte(0x0)),1,5000)

    usb.usbReleaseInterface(handle,0)
    usb.usbClose(handle)
